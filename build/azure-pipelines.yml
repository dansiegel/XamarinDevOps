trigger:
  branches:
    include:
    - master
    - dev
    - rel/*
  paths:
    exclude:
    - README.md
    - .editorconfig
    - .gitignore

pr:
  branches:
    include:
    - master
    - dev
  paths:
    exclude:
    - README.md
    - .editorconfig
    - .gitignore

name: $(Build.BuildId)

variables:
- name: BuildConfiguration
  value: 'Release'
- name: TargetSolution
  value: 'DemoDevOps.sln'
- group: DemoDevOps-Secrets
- group: iOS-Signing
- group: AndroidSigning

stages:
- stage: QA
  displayName: QA
  jobs:
  - job: iOS_QA
    displayName: iOS QA Build
    condition: not(startsWith(variables['Build.SourceBranch'], 'refs/heads/rel/'))
    pool:
      vmImage: macOS-latest
      demands:
      - MSBuild
      - xcode
      - Xamarin.iOS
    steps:
      - template: jobs/ios.yml
        parameters:
          solution: $(TargetSolution)
          appcenterKey: $(AppCenterKey_iOS_QA)
          artifactName: 'iOS-QA'
          isStoreRelease: false
          buildConfiguration: Release
          iOSCertificateFile: $(iOSDevelopmentCertificate)
          iOSCertificatePassword: $(iOSDevelopmentPassword)
          iOSProvisioningProfile: $(iOSDevelopmentProvisioningProfile)

  - job: Android_QA
    displayName: Android QA Build
    condition: not(startsWith(variables['Build.SourceBranch'], 'refs/heads/rel/'))
    pool:
      vmImage: macOS-latest
      demands:
      - MSBuild
      - Xamarin.Android
      - JDK
      - AndroidSDK
    steps:
      - template: jobs/android.yml
        parameters:
          solution: $(TargetSolution)
          appcenterKey: $(AppCenterKey_Android_QA)
          artifactName: 'Droid-QA'
          environment: 'QA'

- stage: production
  displayName: Production
  jobs:
  - job: iOS_Release
    displayName: iOS Release Build
    condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/rel/')
    pool:
      vmImage: macOS-latest
      demands:
      - MSBuild
      - xcode
      - Xamarin.iOS
    steps:
      - template: jobs/ios.yml
        parameters:
          solution: $(TargetSolution)
          appcenterKey: $(AppCenterKey_iOS_Store)
          artifactName: 'iOS-Store'
          isStoreRelease: true
          buildConfiguration: Store
          iOSCertificateFile: $(iOSDistributionCertificate)
          iOSCertificatePassword: $(iOSDistributionPassword)
          iOSProvisioningProfile: $(iOSDistributionProvisioningProfile)

  - job: Android_Release
    displayName: Android Release Build
    condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/rel/')
    pool:
      vmImage: macOS-latest
      demands:
      - MSBuild
      - Xamarin.Android
      - JDK
      - AndroidSDK
    steps:
      - template: jobs/android.yml
        parameters:
          solution: $(TargetSolution)
          appcenterKey: $(AppCenterKey_Android_Store)
          artifactName: 'Droid-Store'
          environment: 'Store'

- stage: deploy
  displayName: Deploy
  condition: startsWith(variables['Build.SourceBranch'], 'refs/heads/rel/')
  jobs:
  - deployment: GooglePlay
    displayName: Google Play
    environment: Google Play
    strategy:
      runOnce:
        deploy:
          steps:
            - task: GooglePlayReleaseBundle@3
              inputs:
                serviceConnection: 'GooglePlay'
                applicationId: 'com.avantipoint.demodevops'
                bundleFile: 'Droid-Store/com.avantipoint.demodevops-Signed.aab'
                track: 'internal'
                rolloutToUserFraction: true
